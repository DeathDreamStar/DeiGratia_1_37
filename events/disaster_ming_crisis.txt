namespace = ming_crisis

# Mandate Questioned
country_event = {
	id = ming_crisis.1
	title = "ming_crisis.1.t"
	desc = "ming_crisis.1.d"
	picture = CIVIL_WAR_eventPicture
	
	is_triggered_only = yes
	fire_only_once = yes
	
	immediate = {
		hidden_effect = {
			random_owned_province = {
				limit = {
					is_state = yes
					superregion = china_superregion
				}
				spawn_rebels = {
					type = anti_tax_rebels 
					size = 3
				}
			}
			random_owned_province = {
				limit = {
					is_state = yes
					superregion = china_superregion
				}
				spawn_rebels = {
					type = anti_tax_rebels 
					size = 3
				}
			}
			random_owned_province = {
				limit = {
					is_state = yes
					superregion = china_superregion
				}
				spawn_rebels = {
					type = anti_tax_rebels 
					size = 3
				}
			}
			random_owned_province = {
				limit = {
					is_state = yes
					superregion = china_superregion
				}
				spawn_rebels = {
					type = anti_tax_rebels 
					size = 3
				}
			}
			random_owned_province = {
				limit = {
					is_state = yes
					superregion = china_superregion
				}
				spawn_rebels = {
					type = anti_tax_rebels 
					size = 3
				}
			}
		}
	}
	
	option = {
		name = ming_crisis.1.a
		add_stability = -2
		add_mandate = -35
		add_corruption = 5
	}
}

# The Mandate Restored
country_event = {
	id = ming_crisis.2
	title = "ming_crisis.2.t"
	desc = "ming_crisis.2.d"
	picture = CIVIL_WAR_eventPicture
	
	is_triggered_only = yes
	
	option = {
		name = ming_crisis.2.a
		add_stability = 1
		add_mandate = 20
	}
}

# Li Zicheng's rebellion and the Shun dynasty
country_event = {
	id = ming_crisis.3
	title = "ming_crisis.3.t"
	desc = "ming_crisis.3.d"
	picture = ANGRY_MOB_eventPicture
	
	is_triggered_only = yes
	fire_only_once = yes
	major = yes
	
	trigger = {
		NOT = { exists = CSH }
		num_of_owned_provinces_with = {
			value = 10
			region = north_china_region
			controlled_by = REB
		}
		any_owned_province = {
			OR = {
				area = gansu_area
				area = west_gansu_area
				area = shaanxi_area
				area = north_shaanxi_area
				area = west_henan_area
				area = henan_area
				area = ordos_area
				area = ningxia_area
				area = alxa_area
			}
		}
	}
	
	immediate = {
		set_country_flag = shun_revolt_flag
		hidden_effect = {
			every_owned_province = {
				limit = {
					OR = {
						area = gansu_area
						area = west_gansu_area
						area = shaanxi_area
						area = north_shaanxi_area
						area = west_henan_area
						area = henan_area
						area = ordos_area
						area = ningxia_area
						area = alxa_area
					}
				}
				add_core = CSH
				clear_rebels = yes
			}
			release = CSH
			CSH = {
				change_religion = confucianism
				capital_scope = {
					build_to_forcelimit = {
						infantry = 3.6
						cavalry = 1.2
						artillery = 1.2
					}
				}
				change_government = monarchy
				add_government_reform = warring_state
				adopt_reform_progress = ROOT
				define_ruler = {
					name = "Zicheng"
					dynasty = "Li"
					religion = confucianism
				}
				add_yearly_manpower = 3
				add_years_of_income = 3
			}
		}
	}
	
	option = {
		name = ming_crisis.3.a
		ai_chance = {
			factor = 100
		}
		add_stability = -2
		add_mandate = -10
		if = {
			limit = {
				is_emperor_of_china = yes
			}
			CSH = {
				declare_war_with_cb = {
					who = ROOT
					casus_belli = cb_take_mandate
				}
			}
		}
		else = {
			CSH = {
				declare_war = ROOT
			}
		}
	}

	option = {
		name = ming_crisis.3.b
		ai_chance = {
			factor = 0
		}
		hidden_effect = {
			add_stability = -2
			add_mandate = -10
			if = {
				limit = {
					is_emperor_of_china = yes
				}
				CSH = {
					declare_war_with_cb = {
						who = ROOT
						casus_belli = cb_take_mandate
					}
				}
			}
			else = {
				CSH = {
					declare_war = ROOT
				}
			}
		}
		switch_tag = CSH
	}

	after = {
		hidden_effect = {
			CSH = {
				if = {
					limit = {
						any_neighbor_country = {
							
							total_own_and_non_tributary_subject_development = 300
							is_subject = no
							#NOT = { truce_with = ROOT }
							NOT = { alliance_with = ROOT }
							#NOT = { is_subject_of = ROOT }
						}
					}
					random_neighbor_country = {
						limit = {
							has_reform = steppe_horde
							total_own_and_non_tributary_subject_development = 300
							is_subject = no
							#NOT = { truce_with = ROOT }
							NOT = { alliance_with = ROOT }
							#NOT = { is_subject_of = ROOT }
						}
						country_event = { id = ming_crisis.9 days = 1 }
					}
				}
				else_if = {
					limit = {
						any_neighbor_country = {
							tag = MCH
							is_free_or_tributary_trigger = yes
							NOT = { alliance_with = root }
						}
					}
					MCH = {
						country_event = { id = ming_crisis.9 days = 1 }
					}
				}
			}
		}
	}
}

# Peasants revolt in [area]
country_event = {
	id = ming_crisis.6
	title = "ming_crisis.6.t"
	desc = "ming_crisis.6.d"
	picture = ANGRY_MOB_eventPicture
	
	is_triggered_only = yes
	
	trigger = {
		any_owned_province = {
			is_state = yes
			superregion = china_superregion
			NOT = { local_autonomy = 75 }
		}
	}
	
	immediate = {
		hidden_effect = {
			random_owned_province = {
				limit = {
					is_state = yes
					superregion = china_superregion
					NOT = { local_autonomy = 75 }
				}
				save_event_target_as = ming_disaster_rebel_province
			}
		}
	}
	
	option = {
		name = ming_crisis.6.a
		ai_chance = { factor = 1 }
		add_mandate = 5
		event_target:ming_disaster_rebel_province = {
			spawn_rebels = {
				type = anti_tax_rebels 
				size = 3
			}
		}
	}
	option = {
		name = ming_crisis.6.b
		ai_chance = { factor = 0 }
		add_mandate = -5
		event_target:ming_disaster_rebel_province = {
			area = {
				limit = {
					owned_by = ROOT
				}
				add_local_autonomy = 50
			}
		}
	}
}


# Gatekeeper for ending depending on whether you kept the Mandate or not
country_event = {
	id = ming_crisis.7
	title = none
	desc = none
	picture = none
	hidden = yes
	
	is_triggered_only = yes
	fire_only_once = yes
	
	immediate = {
		hidden_effect = {
			set_country_flag = ming_crisis_happened
		}
		if = {
			limit = {
				is_emperor_of_china = yes
			}
			country_event = { id = ming_crisis.2 }
		}
		else = {
			country_event = { id = ming_crisis.8 }
		}
	}
	option = { }
}

# The Mandate Restored
country_event = {
	id = ming_crisis.8
	title = "ming_crisis.8.t"
	desc = "ming_crisis.8.d"
	picture = CIVIL_WAR_eventPicture
	
	is_triggered_only = yes

	immediate = {
		hidden_effect = {
			random_country = {
				limit = {
					is_emperor_of_china = yes
				}
				save_event_target_as = emperor_of_china
			}
		}
	}
	
	option = {
		name = ming_crisis.8.a
		add_stability = 1
	}
}


# Manchu/Nomadic Intervention on Shun
country_event = {
	id = ming_crisis.9
	title = "ming_crisis.9.t"
	desc = "ming_crisis.9.d"
	picture = ANGRY_MOB_eventPicture
	
	is_triggered_only = yes
	major = yes
	
	option = {
		name = ming_crisis.9.A

		CSH = {
			every_owned_province = {
				limit = {
					NOT = {
						is_claim = ROOT
						is_core = ROOT
					}
				}
				add_claim = ROOT
			}
		}

		if = {
			limit = {
				has_casus_belli = {
					type = cb_horde_vs_civ
					target = CSH
				}
			}
			declare_war_with_cb = {
				who = CSH
				casus_belli = cb_horde_vs_civ
			}
		}
		else = {
			declare_war_with_cb = {
				who = CSH
				casus_belli = cb_conquest
			}
		}

		ai_chance = {
			factor = 5
			modifier = {
				factor = 0.67
				has_opinion = {
					who = from
					value = 10
				}
			}
			modifier = {
				factor = 0.5
				has_opinion = {
					who = from
					value = 50
				}
			}
			modifier = {
				factor = 0.2
				has_opinion = {
					who = from
					value = 100
				}
			}
			modifier = {
				factor = 0.5
				is_at_war = yes
				NOT = { war_score = 0 }
			}
			modifier = {
				factor = 0
				is_at_war = yes
				NOT = { war_score = -15 }
			}
			modifier = {
				factor = 0.2
				is_in_large_debt = yes
			}
		}
	}

	option = {
		name = ming_crisis.9.B

		add_prestige = -20

		ai_chance = {
			factor = 1
			modifier = {
				factor = 0.01
				OR = {
					ai_attitude = {
						who = from
						attitude = attitude_hostile
					}
					is_rival = from
				}
			}
		}
	}
}